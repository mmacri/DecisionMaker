<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CISR Managed Training | CIP-007 Security Management</title>
  <style>
    :root {
      color-scheme: light;
      --bg: #f5f6f8;
      --panel: #ffffff;
      --text: #111827;
      --muted: #4b5563;
      --accent: #0f766e;
      --accent-2: #2563eb;
      --border: #e5e7eb;
      --card: #ffffff;
      --shadow: 0 12px 30px rgba(15, 23, 42, 0.08);
      --radius: 14px;
      font-synthesis: none;
      text-rendering: optimizeLegibility;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      min-height: 100vh;
      background: var(--bg);
      font-family: "Inter", "Segoe UI", system-ui, -apple-system, sans-serif;
      color: var(--text);
    }

    header {
      position: sticky;
      top: 0;
      z-index: 5;
      background: rgba(255, 255, 255, 0.96);
      border-bottom: 1px solid var(--border);
      padding: 0.75rem 1.5rem 0.65rem;
      backdrop-filter: blur(10px);
    }

    header h1 {
      margin: 0;
      font-size: 1.6rem;
      letter-spacing: 0.01em;
    }

    header p {
      margin: 0.35rem 0 0.5rem;
      color: var(--muted);
    }

    .top-row {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      flex-wrap: wrap;
      justify-content: space-between;
    }

    #nav-toggle {
      display: none;
      border: 1px solid var(--border);
      background: var(--card);
      padding: 0.45rem 0.75rem;
      border-radius: 10px;
      cursor: pointer;
    }

    nav.top-nav {
      display: flex;
      gap: 0.75rem;
      flex-wrap: wrap;
      margin-top: 0.35rem;
    }

    nav.top-nav button {
      font: inherit;
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 0.5rem 0.85rem;
      background: var(--card);
      color: var(--text);
      cursor: pointer;
      transition: transform 160ms ease, border-color 160ms ease, background 160ms ease;
    }

    nav.top-nav button.active {
      border-color: var(--accent);
      background: #e0f2f1;
    }

    nav.top-nav button:hover { transform: translateY(-1px); }

    .layout {
      display: grid;
      grid-template-columns: 320px 1fr;
      gap: 1rem;
      padding: 1rem 1.25rem 2rem;
    }

    aside {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 1rem;
      position: sticky;
      top: 96px;
      height: fit-content;
    }

    .module-card {
      display: flex;
      flex-direction: column;
      gap: 0.6rem;
      padding: 0.75rem;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: var(--card);
    }

    .module-card h3 { margin: 0; }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      font-size: 0.85rem;
      padding: 0.3rem 0.75rem;
      border-radius: 999px;
      background: #e0f2f1;
      border: 1px solid #b2dfdb;
      color: var(--text);
      width: fit-content;
    }

    .badge.secondary {
      background: #e1e9ff;
      border-color: #c7d2fe;
    }

    button, .link-btn {
      font: inherit;
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 0.65rem 0.85rem;
      background: var(--card);
      color: var(--text);
      cursor: pointer;
      transition: transform 160ms ease, box-shadow 160ms ease, border-color 160ms ease, background 160ms ease;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }

    button:hover, .link-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 12px 30px rgba(0, 0, 0, 0.08);
      border-color: var(--accent);
      background: #f8fafc;
    }

    button:focus-visible, .link-btn:focus-visible {
      outline: 2px solid var(--accent);
      outline-offset: 2px;
    }

    .section-panel {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 1rem;
      margin-top: 1rem;
    }

    .section-panel h4 { margin: 0 0 0.35rem; }

    .section-panel ul { margin: 0; padding-left: 1.1rem; color: var(--muted); }

    .embed {
      border: none;
      width: 100%;
      height: calc(100vh - 200px);
      border-radius: 12px;
      background: var(--card);
    }

    .viewer {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      min-height: 80vh;
      padding: 1rem;
      box-shadow: var(--shadow);
      overflow: hidden;
    }

    .controls { display: flex; flex-direction: column; gap: 0.6rem; }

    .status {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      color: var(--muted);
      font-size: 0.95rem;
    }

    .status .dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: var(--accent-2);
      box-shadow: 0 0 0 6px rgba(34, 197, 94, 0.14);
    }

    .grid { display: grid; gap: 0.8rem; }
    .two-col { grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); }

    .highlight {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 1rem;
      margin: 0.5rem 0;
    }

    .lead { color: var(--muted); }

    .cert-list { margin: 0; padding-left: 1.1rem; }

    .section.hidden { display: none; }

    .footer-note {
      margin-top: 1rem;
      color: var(--muted);
      font-size: 0.9rem;
      line-height: 1.5;
    }

    .back-top {
      position: fixed;
      bottom: 16px;
      right: 16px;
      padding: 0.6rem 0.9rem;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: var(--card);
      color: var(--text);
      cursor: pointer;
      box-shadow: var(--shadow);
      z-index: 5;
    }

    .toast-container {
      position: fixed;
      top: 18px;
      right: 18px;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      z-index: 10;
    }

    .toast {
      background: var(--card);
      border: 1px solid var(--border);
      border-left: 4px solid var(--accent);
      padding: 0.75rem 1rem;
      border-radius: 10px;
      box-shadow: var(--shadow);
      opacity: 0;
      transform: translateY(-6px);
      transition: opacity 180ms ease, transform 180ms ease;
    }

    .toast.visible {
      opacity: 1;
      transform: translateY(0);
    }

    .toast.success { border-left-color: #15803d; }

    .overlay {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.72);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 1rem;
      z-index: 15;
    }

    .overlay[hidden] { display: none; }

    .overlay-card {
      background: var(--panel);
      border-radius: 16px;
      padding: 1.25rem;
      width: min(560px, 100%);
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
    }

    .overlay-card h2 {
      margin: 0 0 0.5rem;
    }

    .overlay-card p {
      margin: 0 0 1rem;
      color: var(--muted);
    }

    .overlay-card form {
      display: grid;
      gap: 0.75rem;
    }

    .field {
      display: grid;
      gap: 0.35rem;
    }

    .field input,
    .field select {
      width: 100%;
      padding: 0.65rem 0.75rem;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: var(--card);
      color: var(--text);
    }

    .meta-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 0.6rem;
    }

    .profile-pill {
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      padding: 0.4rem 0.8rem;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: #f8fafc;
      color: var(--muted);
      font-size: 0.9rem;
    }

    @media (max-width: 980px) {
      .layout { grid-template-columns: 1fr; }
      aside { position: static; }
      .embed { height: 70vh; }
    }

    @media (max-width: 760px) {
      #nav-toggle { display: inline-flex; }
      nav.top-nav { display: none; width: 100%; }
      body.nav-open nav.top-nav { display: flex; }
      nav.top-nav button { width: 100%; justify-content: flex-start; }
    }
  </style>
</head>
<body>
  <div class="overlay" id="registration-overlay" role="dialog" aria-modal="true" aria-labelledby="registration-title" hidden>
    <div class="overlay-card">
      <h2 id="registration-title">Choose your role to begin</h2>
      <p>We personalize the CSIR-guided training path, capture your certificate details, and store a local-only roster for audit-friendly reporting.</p>
      <form id="registration-form">
        <div class="field">
          <label for="reg-name">Full name</label>
          <input id="reg-name" name="name" autocomplete="name" placeholder="Enter your name for the certificate" required />
        </div>
        <div class="field">
          <label for="reg-email">Work email</label>
          <input id="reg-email" name="email" type="email" autocomplete="email" placeholder="name@example.com" required />
        </div>
        <div class="field">
          <label for="reg-role">Role</label>
          <select id="reg-role" name="role" required>
            <option value="">Select your role</option>
            <option>Operator</option>
            <option>System Administrator</option>
            <option>Security Analyst</option>
            <option>Compliance / Audit</option>
          </select>
        </div>
        <div class="meta-grid">
          <div class="highlight" style="margin:0;">
            <strong>Audit-friendly</strong>
            <p class="lead">Start and completion dates stay in a secured local list for quick reporting.</p>
          </div>
          <div class="highlight" style="margin:0;">
            <strong>Role-guided</strong>
            <p class="lead">Navigation and certificates are tailored to the CSIR track you select.</p>
          </div>
        </div>
        <button type="submit" id="registration-submit">Start training</button>
        <p class="footer-note">Details never leave this device. They are only used for your guided experience and certificate download.</p>
      </form>
    </div>
  </div>
  <header>
    <div class="top-row">
      <div>
        <h1>CISR Managed Training</h1>
        <p>Live, self-contained delivery of CIP-007 Security Management content sourced from the official GitHub materials.</p>
      </div>
      <button id="nav-toggle" aria-label="Toggle navigation">☰</button>
    </div>
    <nav class="top-nav" aria-label="Primary navigation">
      <button data-section="training" class="active">My Training</button>
      <button data-section="learning">My Learning</button>
      <button data-section="practice">Practice</button>
      <button data-section="resources">Resources</button>
      <button data-section="about">About</button>
    </nav>
  </header>

  <div class="layout">
    <aside aria-label="Module navigation">
      <div class="module-card">
        <h3>Module 6 – CIP-007 System Security Management</h3>
        <p class="badge">CISR Ready</p>
        <p>Use the controls below to load and review the audited training module with zero external dependencies.</p>
        <div class="controls">
          <button id="launch" disabled title="Complete registration to begin">Launch training module</button>
          <a class="link-btn" id="open-tab" href="modules/cip007/setup.html" target="_blank" rel="noopener">Open in new tab</a>
          <a class="link-btn" href="modules/cip007/csir.html">Try the CIP-007 CSIR guided path</a>
          <button id="complete-module" class="link-btn" style="justify-content:center;">Complete module & issue certificate</button>
          <div class="status"><span class="dot" aria-hidden="true"></span><span id="status-text">Module cached locally</span></div>
        </div>
      </div>

      <div class="section-panel">
        <h4>Training sections</h4>
        <ul id="progress-list" aria-live="polite"></ul>
      </div>

      <div class="section-panel">
        <h4>Certificates</h4>
        <ul class="cert-list" id="cert-list"></ul>
        <p class="footer-note" id="cert-hint" style="margin-top:0.5rem;">Certificates appear here once earned.</p>
      </div>

      <div class="footer-note">
        The viewer embeds the published module directly from <code>modules/cip007/setup.html</code>, matching the content on
        the GitHub site. All assets are local for disconnected or audit-ready use.
      </div>
    </aside>

    <main class="viewer" aria-live="polite">
      <div id="profile-banner" class="profile-pill" role="status" aria-live="polite" style="display:none;margin-bottom:0.75rem;"></div>
      <section id="training" class="section">
        <iframe id="module-frame" class="embed" title="CIP-007 Training Module" src="about:blank"></iframe>
      </section>

      <section id="learning" class="section hidden">
        <div class="grid two-col">
          <div class="highlight">
            <h2>My Learning Dashboard</h2>
            <p class="lead">Capture your name, role, and goals to personalize training and track progress across modules.</p>
            <label>Full name
              <input id="learner-name" type="text" style="width:100%;padding:0.6rem;border-radius:10px;border:1px solid var(--border);background:var(--card);color:var(--text);margin-top:0.3rem;" placeholder="Enter your preferred display name" />
            </label>
            <label>Email
              <input id="learner-email" type="email" style="width:100%;padding:0.6rem;border-radius:10px;border:1px solid var(--border);background:var(--card);color:var(--text);margin-top:0.3rem;" placeholder="name@example.com" />
            </label>
            <div style="margin-top:0.75rem; display:grid; gap:0.5rem;">
              <label>Role
                <select id="learner-role" style="width:100%;padding:0.6rem;border-radius:10px;border:1px solid var(--border);background:var(--card);color:var(--text);margin-top:0.3rem;">
                  <option value="">Select your role</option>
                  <option>Operator</option>
                  <option>System Administrator</option>
                  <option>Security Analyst</option>
                  <option>Compliance / Audit</option>
                </select>
              </label>
              <label>Learning goal
                <select id="learner-goal" style="width:100%;padding:0.6rem;border-radius:10px;border:1px solid var(--border);background:var(--card);color:var(--text);margin-top:0.3rem;">
                  <option value="">Pick a focus</option>
                  <option>Basic awareness</option>
                  <option>Operational readiness</option>
                  <option>Audit preparation</option>
                </select>
              </label>
            </div>
            <div style="margin-top:0.75rem;display:flex;gap:0.5rem;">
              <button id="save-profile" title="Save your profile for personalized recommendations">Save profile</button>
              <button id="reset-progress" class="link-btn" style="margin-left:auto;" title="Clear your profile and module progress">Reset progress</button>
            </div>
          </div>
          <div class="highlight">
            <h3>Overall Progress</h3>
            <p class="lead" id="overall-progress">No activity yet. Launch a module to start.</p>
            <ul id="module-summary"></ul>
            <div id="role-guidance" class="footer-note"></div>
          </div>
        </div>

        <div class="section-panel" style="margin-top:1rem;">
          <h3>Certificates</h3>
          <ul id="dashboard-certificates"></ul>
        </div>

        <div class="section-panel" style="margin-top:1rem;">
          <h3>Local reporting roster</h3>
          <p class="lead">A secured local list of learners, their emails, and start/completion dates for your records.</p>
          <div id="roster"></div>
        </div>
      </section>

      <section id="practice" class="section hidden">
        <h2>Practice</h2>
        <p class="lead">Short drills and scenarios to stay sharp between formal modules.</p>
        <div class="grid two-col">
          <div class="highlight">
            <h3>Scenario refresh</h3>
            <p>Revisit the incident and remote-access scenarios to rehearse the right response paths.</p>
            <a class="link-btn" href="modules/cip007/scenarios.html" target="_blank">Open scenarios</a>
          </div>
          <div class="highlight">
            <h3>Mini-quiz</h3>
            <p>Validate your knowledge with a quick 4-question check that mirrors the full assessment.</p>
            <a class="link-btn" href="modules/cip007/knowledge-check.html" target="_blank">Start mini-quiz</a>
          </div>
        </div>
      </section>

      <section id="resources" class="section hidden">
        <h2>Resources</h2>
        <div class="grid two-col">
          <div class="highlight">
            <h3>Operational checklists</h3>
            <p>Downloadable, printable task lists for each requirement with evidence notes and cadence reminders.</p>
            <a class="link-btn" href="modules/cip007/checklist.html" target="_blank">Open checklist</a>
          </div>
          <div class="highlight">
            <h3>Policy references</h3>
            <p>Consolidated references to patch management, remote access, malware prevention, and monitoring standards.</p>
            <a class="link-btn" href="training/cip-007-csir/metadata.json" target="_blank">View metadata</a>
          </div>
        </div>
      </section>

      <section id="about" class="section hidden">
        <h2>About this experience</h2>
        <p class="lead">A streamlined training delivery with persistent navigation, audit-ready content, and certificate tracking.</p>
        <div class="highlight">
          <ul>
            <li>Reduced scrolling with sticky navigation and section jumping.</li>
            <li>Audit etiquette is now included for audit-prep learners.</li>
            <li>Certificates auto-generate when assessments and checklists are done.</li>
          </ul>
        </div>
      </section>
    </main>
  </div>

  <button class="back-top" aria-label="Back to top" id="back-top">↑ Back to top</button>
  <div class="toast-container" id="toast-container" aria-live="polite" aria-atomic="true"></div>

  <script>
    const frame = document.getElementById('module-frame');
    const statusText = document.getElementById('status-text');
    const moduleConfig = {
      id: 'cip007-guided',
      title: 'Module 6 – CIP-007 Security Management',
      path: 'modules/cip007/setup.html'
    };

    const STORAGE_KEY = 'cisr-learning-profile';

    function loadState() {
      try {
        const parsed = JSON.parse(localStorage.getItem(STORAGE_KEY)) || {};
        return {
          learner: parsed.learner || {},
          modules: parsed.modules || {},
          certificates: parsed.certificates || [],
          registry: parsed.registry || []
        };
      } catch (err) {
        return { learner: {}, modules: {}, certificates: [], registry: [] };
      }
    }

    function saveState(next) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(next));
      renderCertificates(next);
      renderProgress(next);
      renderDashboard(next);
      renderProfileBanner(next);
      renderRoster(next);
      renderRoleGuidance(next);
    }

    function upsertRegistry(state, completionDate) {
      const { learner } = state;
      if (!learner.email || !learner.name || !learner.role) return;
      const existing = state.registry.findIndex((entry) => entry.email === learner.email);
      const record = {
        name: learner.name,
        email: learner.email,
        role: learner.role,
        startDate: learner.startDate || new Date().toISOString(),
        completionDate: completionDate || learner.completionDate || ''
      };
      if (existing >= 0) {
        state.registry[existing] = { ...state.registry[existing], ...record };
      } else {
        state.registry.push(record);
      }
    }

    function ensureRegistration() {
      const state = loadState();
      if (state.learner.name && state.learner.email && state.learner.role) {
        document.getElementById('launch').disabled = false;
        return true;
      }
      document.getElementById('reg-name').value = state.learner.name || '';
      document.getElementById('reg-email').value = state.learner.email || '';
      document.getElementById('reg-role').value = state.learner.role || '';
      document.getElementById('registration-overlay').hidden = false;
      showToast('Please enter your name, email, and role to continue.', 'info');
      return false;
    }

    function loadModule() {
      if (!ensureRegistration()) return;
      statusText.textContent = 'Loading module…';
      frame.src = moduleConfig.path;
      statusText.textContent = 'Module ready — navigation updated';
      const state = loadState();
      state.learner.startDate = state.learner.startDate || new Date().toISOString();
      upsertRegistry(state);
      state.modules[moduleConfig.id] = state.modules[moduleConfig.id] || { title: moduleConfig.title, status: 'Started' };
      saveState(state);
    }

    function renderProgress(state) {
      const list = document.getElementById('progress-list');
      list.innerHTML = '';
      const module = state.modules[moduleConfig.id];
      if (!module) {
        list.innerHTML = '<li>Launch a module to see section progress.</li>';
        return;
      }
      const li = document.createElement('li');
      li.innerHTML = `<strong>${module.title}</strong><br /><span class="lead">${module.status || 'In progress'}</span>`;
      if (module.lastSection) {
        const resume = document.createElement('a');
        resume.href = `${moduleConfig.path}#${module.lastSection}`;
        resume.textContent = 'Resume where you left off';
        resume.className = 'link-btn';
        resume.style.marginTop = '0.5rem';
        resume.target = '_blank';
        resume.rel = 'noopener';
        li.appendChild(document.createElement('br'));
        li.appendChild(resume);
      }
      list.appendChild(li);
    }

    function renderCertificates(state) {
      const certList = document.getElementById('cert-list');
      const hint = document.getElementById('cert-hint');
      certList.innerHTML = '';
      if (!state.certificates.length) {
        hint.style.display = 'block';
        certList.innerHTML = '<li class="lead">Finish a knowledge check and checklist to claim a certificate.</li>';
        return;
      }
      hint.style.display = 'none';
      state.certificates.forEach((cert) => {
        const item = document.createElement('li');
        item.innerHTML = `<strong>${cert.module}</strong><br /><span class="lead">Issued ${cert.date}</span>`;
        item.innerHTML += `<br />To ${cert.name}${cert.role ? ` (${cert.role})` : ''}${cert.email ? ` · ${cert.email}` : ''}`;
        const link = document.createElement('a');
        link.href = cert.link;
        link.textContent = 'Download certificate';
        link.download = cert.filename;
        link.className = 'link-btn';
        link.style.marginTop = '0.35rem';
        item.appendChild(document.createElement('br'));
        item.appendChild(link);
        certList.appendChild(item);
      });
    }

    function renderDashboard(state) {
      document.getElementById('learner-name').value = state.learner.name || '';
      document.getElementById('learner-email').value = state.learner.email || '';
      document.getElementById('learner-role').value = state.learner.role || '';
      document.getElementById('learner-goal').value = state.learner.goal || '';

      const summary = document.getElementById('module-summary');
      const certificates = document.getElementById('dashboard-certificates');
      const overall = document.getElementById('overall-progress');
      summary.innerHTML = '';
      certificates.innerHTML = '';

      const modules = Object.values(state.modules || {});
      if (!modules.length) {
        overall.textContent = 'No activity yet. Launch a module to start.';
      } else {
        const completed = modules.filter((m) => m.status === 'Completed').length;
        const started = modules.length;
        const scoreText = modules
          .filter((m) => m.knowledgeScore)
          .map((m) => `${m.title}: ${m.knowledgeScore}%`)
          .join(' · ');
        overall.textContent = `${completed} of ${started} modules completed.` + (scoreText ? ` Scores: ${scoreText}` : '');
        modules.forEach((m) => {
          const item = document.createElement('li');
          item.innerHTML = `<strong>${m.title}</strong><br /><span class="lead">${m.status || 'In progress'}</span>`;
          if (m.knowledgeScore) {
            item.innerHTML += `<br /><span class="badge secondary">Knowledge check: ${m.knowledgeScore}%</span>`;
          }
          if (m.lastSection) {
            const resume = document.createElement('a');
            resume.href = `${moduleConfig.path}#${m.lastSection}`;
            resume.textContent = 'Resume module';
            resume.className = 'link-btn';
            resume.style.marginTop = '0.35rem';
            resume.target = '_blank';
            resume.rel = 'noopener';
            item.appendChild(document.createElement('br'));
            item.appendChild(resume);
          }
          summary.appendChild(item);
        });
      }

      if (!state.certificates.length) {
        certificates.innerHTML = '<li class="lead">Earn a certificate by passing a knowledge check (≥80%) and completing the checklist.</li>';
      } else {
        state.certificates.forEach((cert) => {
          const li = document.createElement('li');
          li.innerHTML = `<strong>${cert.module}</strong> · ${cert.date}<br />Issued to ${cert.name}`;
          if (cert.role) li.innerHTML += ` (${cert.role})`;
          if (cert.email) li.innerHTML += `<br /><span class="lead">Email: ${cert.email}</span>`;
          const link = document.createElement('a');
          link.href = cert.link;
          link.download = cert.filename;
          link.textContent = 'Download certificate';
          link.className = 'link-btn';
          link.style.marginTop = '0.35rem';
          li.appendChild(document.createElement('br'));
          li.appendChild(link);
          certificates.appendChild(li);
        });
      }
    }

    function renderProfileBanner(state) {
      const banner = document.getElementById('profile-banner');
      const { name, role, goal } = state.learner || {};
      if (!name && !role && !goal) {
        banner.style.display = 'none';
        return;
      }
      const roleText = role ? `· ${role}` : '';
      const goalText = goal ? `· ${goal}` : '';
      banner.textContent = `${name || 'Learner'} ${roleText} ${goalText}`.trim();
      banner.style.display = 'inline-flex';
    }

    function issueCertificate() {
      if (!ensureRegistration()) return;
      const state = loadState();
      const now = new Date();
      state.learner.startDate = state.learner.startDate || now.toISOString();
      state.learner.completionDate = state.learner.completionDate || now.toISOString();
      const moduleEntry = state.modules[moduleConfig.id] || { title: moduleConfig.title };
      moduleEntry.status = 'Completed';
      moduleEntry.lastSection = 'certificate';
      moduleEntry.knowledgeScore = moduleEntry.knowledgeScore || 100;
      moduleEntry.completedOn = moduleEntry.completedOn || now.toISOString();
      state.modules[moduleConfig.id] = moduleEntry;

      const certificate = {
        module: moduleConfig.title,
        date: now.toLocaleDateString(),
        name: state.learner.name || 'Learner',
        role: state.learner.role,
        email: state.learner.email,
        filename: `certificate-${moduleConfig.id}-${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, '0')}${String(now.getDate()).padStart(2, '0')}.txt`,
        link: ''
      };

      const certificateBody = `Certificate of Completion\n\nIssued to: ${certificate.name} (${certificate.role})\nEmail: ${certificate.email}\nModule: ${certificate.module}\nStart date: ${state.learner.startDate ? new Date(state.learner.startDate).toLocaleDateString() : 'Not captured'}\nCompletion date: ${new Date(state.learner.completionDate).toLocaleDateString()}\n\nTraining content guided by the CSIR materials included in this site.`;
      const blob = new Blob([certificateBody], { type: 'text/plain' });
      certificate.link = URL.createObjectURL(blob);

      const existingIndex = state.certificates.findIndex((c) => c.module === certificate.module && c.email === certificate.email);
      if (existingIndex >= 0) {
        state.certificates[existingIndex] = certificate;
      } else {
        state.certificates.push(certificate);
      }

      upsertRegistry(state, state.learner.completionDate);
      saveState(state);
      showToast('Certificate ready for download', 'success');
    }

    function renderRoster(state) {
      const roster = document.getElementById('roster');
      if (!roster) return;
      roster.innerHTML = '';
      if (!state.registry || !state.registry.length) {
        roster.innerHTML = '<p class="lead">No registrations yet. Save a profile to build your local roster.</p>';
        return;
      }
      const table = document.createElement('table');
      table.style.width = '100%';
      table.style.borderCollapse = 'collapse';
      const header = document.createElement('tr');
      ['Name', 'Email', 'Role', 'Start date', 'Completion date'].forEach((label) => {
        const th = document.createElement('th');
        th.textContent = label;
        th.style.textAlign = 'left';
        th.style.padding = '0.35rem 0.25rem';
        header.appendChild(th);
      });
      table.appendChild(header);
      state.registry.forEach((entry) => {
        const row = document.createElement('tr');
        [entry.name, entry.email, entry.role, entry.startDate ? new Date(entry.startDate).toLocaleDateString() : '—', entry.completionDate ? new Date(entry.completionDate).toLocaleDateString() : '—'].forEach((value) => {
          const cell = document.createElement('td');
          cell.textContent = value;
          cell.style.padding = '0.35rem 0.25rem';
          cell.style.borderTop = '1px solid var(--border)';
          row.appendChild(cell);
        });
        table.appendChild(row);
      });
      roster.appendChild(table);
    }

    function renderRoleGuidance(state) {
      const target = document.getElementById('role-guidance');
      if (!target) return;
      const guidance = {
        Operator: 'Follow the CSIR scenarios and operations quick-check to stay aligned with field procedures.',
        'System Administrator': 'Prioritize hardening tasks, patch cycles, and remote access controls in the CSIR walkthrough.',
        'Security Analyst': 'Review monitoring triggers, log sources, and incident response steps in the guided module.',
        'Compliance / Audit': 'Use the checklist and metadata links to confirm evidence coverage before assessments.'
      };
      const role = state.learner.role;
      if (!role || !guidance[role]) {
        target.textContent = 'Select a role to see guided CSIR pointers for your track.';
        return;
      }
      target.textContent = guidance[role];
    }

    function showToast(message, variant = 'info') {
      const container = document.getElementById('toast-container');
      const toast = document.createElement('div');
      toast.className = `toast ${variant}`;
      toast.textContent = message;
      container.appendChild(toast);
      requestAnimationFrame(() => toast.classList.add('visible'));
      setTimeout(() => {
        toast.classList.remove('visible');
        setTimeout(() => toast.remove(), 200);
      }, 2800);
    }

    document.getElementById('launch').addEventListener('click', loadModule);
    document.getElementById('complete-module').addEventListener('click', issueCertificate);

    document.getElementById('registration-form').addEventListener('submit', (event) => {
      event.preventDefault();
      const name = document.getElementById('reg-name').value.trim();
      const email = document.getElementById('reg-email').value.trim();
      const role = document.getElementById('reg-role').value;
      if (!name || !email || !role) {
        showToast('Please complete all required fields.', 'info');
        return;
      }
      const state = loadState();
      const now = new Date().toISOString();
      state.learner = {
        ...state.learner,
        name,
        email,
        role,
        startDate: state.learner.startDate || now
      };
      upsertRegistry(state);
      saveState(state);
      document.getElementById('registration-overlay').hidden = true;
      document.getElementById('launch').disabled = false;
      showToast('Registration saved. Launch the module to begin.', 'success');
    });

    document.querySelectorAll('nav.top-nav button').forEach((btn) => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('nav.top-nav button').forEach((b) => b.classList.remove('active'));
        btn.classList.add('active');
        document.querySelectorAll('.section').forEach((section) => section.classList.add('hidden'));
        document.getElementById(btn.dataset.section).classList.remove('hidden');
        window.scrollTo({ top: 0, behavior: 'smooth' });
      });
    });

    document.getElementById('save-profile').addEventListener('click', () => {
      const state = loadState();
      state.learner = {
        name: document.getElementById('learner-name').value.trim(),
        email: document.getElementById('learner-email').value.trim(),
        role: document.getElementById('learner-role').value,
        goal: document.getElementById('learner-goal').value,
        startDate: state.learner.startDate || new Date().toISOString()
      };
      upsertRegistry(state);
      saveState(state);
      showToast('Profile saved', 'success');
    });

    document.getElementById('reset-progress').addEventListener('click', () => {
      if (!confirm('This will clear your saved profile, progress, and certificates. Continue?')) return;
      const cleared = { learner: {}, modules: {}, certificates: [], registry: [] };
      saveState(cleared);
      frame.src = 'about:blank';
      showToast('Progress reset', 'success');
    });

    document.getElementById('back-top').addEventListener('click', () => {
      window.scrollTo({ top: 0, behavior: 'smooth' });
    });

    document.getElementById('nav-toggle').addEventListener('click', () => {
      document.body.classList.toggle('nav-open');
    });

    const initialState = loadState();
    renderProgress(initialState);
    renderCertificates(initialState);
    renderDashboard(initialState);
    renderProfileBanner(initialState);
    renderRoster(initialState);
    renderRoleGuidance(initialState);

    if (initialState.learner.name && initialState.learner.email && initialState.learner.role) {
      document.getElementById('launch').disabled = false;
      loadModule();
    } else {
      document.getElementById('registration-overlay').hidden = false;
    }
  </script>
</body>
</html>
