<!doctype html>
<html lang="en" class="scroll-smooth">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SCL CISR Training Portal</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body { font-family: 'Inter', system-ui, -apple-system, sans-serif; background: #0b1221; }
    .glass { background: rgba(15,23,42,0.8); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.05); }
    .accent { color: #fb7a24; }
    .gradient-border { position: relative; }
    .gradient-border::before { content:''; position:absolute; inset:-1px; border-radius:1rem; padding:2px; background:linear-gradient(120deg,#1d4ed8,#fb7a24,#64748b); -webkit-mask:linear-gradient(#000,#000) content-box,linear-gradient(#000,#000); -webkit-mask-composite:xor; mask-composite:exclude; }
    .gradient-border > div { position:relative; }
  </style>
</head>
<body class="text-slate-100">
  <div class="min-h-screen" id="top">
    <header class="relative overflow-hidden bg-gradient-to-br from-slate-900 via-slate-950 to-slate-900">
      <div class="absolute inset-0 opacity-30 bg-[radial-gradient(circle_at_20%_20%,#1e3a8a,transparent_25%),radial-gradient(circle_at_80%_30%,#fb7a24,transparent_25%)]"></div>
      <div class="max-w-6xl mx-auto px-4 py-10 lg:py-16 relative">
        <div class="flex flex-col lg:flex-row items-start gap-10">
          <div class="flex-1 space-y-6">
            <div class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-white/5 border border-white/10 text-sm">SCL Cyber/Critical Incident Security Response</div>
            <h1 class="text-4xl lg:text-5xl font-bold leading-tight text-white">SCL CISR Training Portal</h1>
            <p class="text-lg text-slate-200 max-w-2xl">Role-based training for the SCL Cyber/Critical Incident Security Response (CISR) plan. Learn the Golden Hour, follow the escalation matrix, rehearse the playbook, and download a certificate on completion.</p>
            <div class="flex flex-wrap gap-3">
              <a href="#training" class="px-5 py-3 rounded-xl bg-white text-slate-900 font-semibold shadow-lg shadow-blue-900/20">Start Training</a>
              <a href="#roles" class="px-5 py-3 rounded-xl border border-white/20 text-white hover:border-orange-400">Choose Your Role</a>
            </div>
            <div class="flex gap-6 text-sm text-slate-300">
              <div class="flex items-center gap-2"><i data-lucide="shield-half" class="w-4 h-4 text-orange-400"></i>Golden Hour: report within 60 minutes</div>
              <div class="flex items-center gap-2"><i data-lucide="clock-3" class="w-4 h-4 text-blue-400"></i>15-minute escalation rule</div>
            </div>
          </div>
          <div class="w-full lg:w-96 gradient-border rounded-2xl">
            <div class="glass rounded-2xl p-6 space-y-4">
              <div class="flex items-center gap-3">
                <div class="h-12 w-12 rounded-xl bg-orange-500/20 flex items-center justify-center text-orange-300"><i data-lucide="award" class="w-6 h-6"></i></div>
                <div>
                  <p class="text-sm text-slate-300">Certification Ready</p>
                  <p class="text-xl font-semibold text-white">Downloadable PDF on completion</p>
                </div>
              </div>
              <div class="space-y-2 text-sm text-slate-300">
                <div class="flex justify-between"><span>Modules</span><span id="progress-count" class="font-semibold">0 / 5</span></div>
                <div class="w-full h-3 rounded-full bg-slate-800 overflow-hidden">
                  <div id="progress-bar" class="h-3 bg-gradient-to-r from-blue-500 via-orange-400 to-amber-300 rounded-full transition-all" style="width:0%"></div>
                </div>
                <p class="text-xs text-slate-400">Progress stored locally so you can return during an incident.</p>
              </div>
              <button id="resumeBtn" class="w-full py-3 rounded-xl bg-orange-500 hover:bg-orange-400 text-slate-900 font-semibold">Resume where I left off</button>
            </div>
          </div>
        </div>
      </div>
    </header>

    <main class="max-w-6xl mx-auto px-4 pb-16" id="training">
      <section id="roles" class="-mt-14 lg:-mt-24 relative z-10">
        <div class="glass rounded-2xl p-6 lg:p-8 shadow-xl shadow-slate-900/40">
          <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
            <div>
              <p class="text-sm text-slate-300">Role selector</p>
              <h2 class="text-2xl font-semibold text-white">Who are you today?</h2>
              <p class="text-slate-400 text-sm">Content will adapt to your responsibilities.</p>
            </div>
            <div class="flex items-center gap-2 text-slate-200"><i data-lucide="user-round" class="w-5 h-5 text-orange-400"></i><span id="role-active">Role not selected</span></div>
          </div>
          <div class="grid md:grid-cols-3 gap-4 mt-6">
            <button data-role="Executive" class="role-card glass border border-white/5 hover:border-orange-400 rounded-xl p-4 text-left space-y-2 transition">
              <div class="flex items-center gap-2 text-orange-300"><i data-lucide="briefcase" class="w-5 h-5"></i><span class="text-sm">Executive</span></div>
              <p class="text-slate-200 font-semibold">Decide quickly, sponsor resources, communicate outward.</p>
              <p class="text-xs text-slate-400">Focus on Golden Hour reporting and stakeholder messaging.</p>
            </button>
            <button data-role="Technical Responder" class="role-card glass border border-white/5 hover:border-orange-400 rounded-xl p-4 text-left space-y-2 transition">
              <div class="flex items-center gap-2 text-orange-300"><i data-lucide="server" class="w-5 h-5"></i><span class="text-sm">Technical Responder</span></div>
              <p class="text-slate-200 font-semibold">Isolate, eradicate, recover. Keep evidence pristine.</p>
              <p class="text-xs text-slate-400">You own containment playbooks and VLAN isolation steps.</p>
            </button>
            <button data-role="General Staff" class="role-card glass border border-white/5 hover:border-orange-400 rounded-xl p-4 text-left space-y-2 transition">
              <div class="flex items-center gap-2 text-orange-300"><i data-lucide="users" class="w-5 h-5"></i><span class="text-sm">General Staff</span></div>
              <p class="text-slate-200 font-semibold">Observe, report, follow communications discipline.</p>
              <p class="text-xs text-slate-400">Stay calm, execute notify steps, and avoid speculation.</p>
            </button>
          </div>
        </div>
      </section>

      <section class="mt-10 grid lg:grid-cols-[1fr_320px] gap-6 items-start" id="course">
        <div class="glass rounded-2xl p-6 lg:p-8 space-y-4 shadow-xl shadow-slate-900/40">
          <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-3">
            <div>
              <p class="text-sm text-slate-300">Course player</p>
              <h2 class="text-2xl font-semibold text-white" id="module-title">Module</h2>
              <p id="module-subtitle" class="text-slate-400 text-sm">Follow the steps below.</p>
            </div>
            <div class="flex gap-2 text-sm text-slate-300">
              <button id="prevBtn" class="px-3 py-2 rounded-lg border border-white/10 hover:border-orange-400">Previous</button>
              <button id="nextBtn" class="px-3 py-2 rounded-lg bg-orange-500 text-slate-900 font-semibold">Next</button>
            </div>
          </div>
          <div id="module-content" class="space-y-4"></div>
        </div>

        <aside class="space-y-4">
          <div class="glass rounded-2xl p-5 border border-white/5">
            <div class="flex items-center gap-2 text-orange-300 mb-2"><i data-lucide="list-checks" class="w-5 h-5"></i><span class="text-sm">Modules</span></div>
            <ul id="module-list" class="space-y-2 text-sm"></ul>
          </div>
          <div class="glass rounded-2xl p-5 border border-white/5 space-y-3">
            <div class="flex items-center gap-2 text-orange-300"><i data-lucide="bell" class="w-5 h-5"></i><span class="text-sm">Quick policies</span></div>
            <ul class="text-slate-300 text-sm list-disc list-inside space-y-1">
              <li>Golden Hour: escalate within 60 minutes.</li>
              <li>15-minute rule: notify the next tier if no response.</li>
              <li>Document evidence, avoid speculation in chat.</li>
              <li>Use approved channels only; never email PII externally.</li>
            </ul>
          </div>
        </aside>
      </section>
    </main>
  </div>

  <script>
    lucide.createIcons();
    const { jsPDF } = window.jspdf;

    const modules = [
      {
        id: 'overview',
        title: 'Module 1: CISR Overview',
        subtitle: "Define an incident and master the Golden Hour.",
        render: () => `
          <div class="grid md:grid-cols-2 gap-4">
            <div class="glass rounded-xl p-4 border border-white/5">
              <h3 class="text-lg font-semibold text-white flex items-center gap-2"><i data-lucide="radar" class="w-5 h-5 text-orange-300"></i>What counts as an incident?</h3>
              <p class="text-slate-300 text-sm mt-2">Any event that threatens confidentiality, integrity, or availability of SCL systems. Examples include ransomware, unauthorized access, data exfiltration, insider misuse, or operational technology disruption.</p>
              <div class="mt-3 text-sm space-y-1 text-slate-200">
                <div class="flex items-start gap-2"><span class="text-orange-400 mt-0.5">•</span><span>Record the time of detection and reporter.</span></div>
                <div class="flex items-start gap-2"><span class="text-orange-400 mt-0.5">•</span><span>Stay within the Golden Hour: triage and notify leadership inside 60 minutes.</span></div>
                <div class="flex items-start gap-2"><span class="text-orange-400 mt-0.5">•</span><span>Use the 15-minute escalation rule if a responder is unreachable.</span></div>
              </div>
            </div>
            <div class="glass rounded-xl p-4 border border-white/5">
              <h3 class="text-lg font-semibold text-white flex items-center gap-2"><i data-lucide="bolt" class="w-5 h-5 text-orange-300"></i>The Golden Hour timeline</h3>
              <ol class="mt-3 space-y-2 text-sm text-slate-200">
                <li class="flex gap-3"><span class="text-orange-400 font-semibold">00:00</span><span>Detect and log. Capture reporter, system, and suspected impact.</span></li>
                <li class="flex gap-3"><span class="text-orange-400 font-semibold">00:15</span><span>Escalate to duty manager if primary responder is unavailable.</span></li>
                <li class="flex gap-3"><span class="text-orange-400 font-semibold">00:30</span><span>Convene incident bridge; invite legal/comms if data or service risk.</span></li>
                <li class="flex gap-3"><span class="text-orange-400 font-semibold">00:60</span><span>Decide on containment and external notifications (e.g., regulators).</span></li>
              </ol>
            </div>
          </div>
          <button class="mark-complete w-full md:w-auto mt-4 px-4 py-2 rounded-lg bg-orange-500 text-slate-900 font-semibold">Mark module complete</button>
        `
      },
      {
        id: 'roles',
        title: 'Module 2: Role-Specific Guidance',
        subtitle: 'See only what applies to your responsibilities.',
        render: (role) => `
          <div class="text-sm text-slate-300">Selected role: <span class="font-semibold text-white">${role || 'Choose a role above'}</span></div>
          <div class="space-y-3 mt-3">
            ${accordionSection('Identify', 'Spot the threat early', identifyContent(role))}
            ${accordionSection('Notify', 'Use the 15-minute escalation rule', notifyContent(role))}
            ${accordionSection('Contain', 'Technical-only VLAN isolation steps', containContent(role))}
            ${accordionSection('Recover', 'Post-incident review protocols', recoverContent(role))}
          </div>
          <p class="text-xs text-slate-400 mt-3">Accordion keeps critical steps skimmable during pressure.</p>
          <button class="mark-complete w-full md:w-auto mt-4 px-4 py-2 rounded-lg bg-orange-500 text-slate-900 font-semibold">Mark module complete</button>
        `
      },
      {
        id: 'communications',
        title: 'Module 3: Communication Protocols',
        subtitle: 'Who to call and when — the SCL escalation matrix.',
        render: () => `
          <div class="grid md:grid-cols-2 gap-4">
            <div class="glass rounded-xl p-4 border border-white/5">
              <h3 class="text-lg font-semibold text-white flex items-center gap-2"><i data-lucide="share-2" class="w-5 h-5 text-orange-300"></i>Escalation matrix</h3>
              <table class="w-full text-sm mt-3 text-slate-200">
                <thead class="text-slate-400">
                  <tr><th class="text-left py-1">Triage level</th><th class="text-left py-1">Notify within</th><th class="text-left py-1">Contacts</th></tr>
                </thead>
                <tbody class="divide-y divide-white/5">
                  <tr><td class="py-2">Critical (OT/Customer impact)</td><td>15 minutes</td><td>Duty Manager, CISO, Communications, Legal</td></tr>
                  <tr><td class="py-2">High (IT service disruption)</td><td>30 minutes</td><td>Incident Commander, SOC Lead, Platform Owners</td></tr>
                  <tr><td class="py-2">Medium (localized)</td><td>60 minutes</td><td>App Owner, Security Liaison</td></tr>
                </tbody>
              </table>
              <p class="text-xs text-slate-400 mt-2">If no acknowledgement, escalate to the next tier after 15 minutes.</p>
            </div>
            <div class="glass rounded-xl p-4 border border-white/5 space-y-3">
              <h3 class="text-lg font-semibold text-white flex items-center gap-2"><i data-lucide="phone-call" class="w-5 h-5 text-orange-300"></i>Notify checklist</h3>
              <div class="relative pl-6 border-l border-white/10 space-y-3">
                ${stepItem('Identify', 'Capture who/what/when. Screenshot evidence safely.')}
                ${stepItem('Notify', 'Page the duty manager. Start an incident bridge with notes.')}
                ${stepItem('Contain', 'Request change freeze. Preserve volatile data.')}
                ${stepItem('Recover', 'Coordinate service restoration. Publish executive summary.')}
              </div>
            </div>
          </div>
          <button class="mark-complete w-full md:w-auto mt-4 px-4 py-2 rounded-lg bg-orange-500 text-slate-900 font-semibold">Mark module complete</button>
        `
      },
      {
        id: 'quiz',
        title: 'Knowledge Check',
        subtitle: 'Five questions to confirm readiness. Score 80% to unlock your certificate.',
        render: () => `
          <form id="quiz-form" class="space-y-4 text-sm"></form>
          <div id="quiz-result" class="text-sm"></div>
          <button type="submit" form="quiz-form" class="w-full md:w-auto mt-2 px-4 py-2 rounded-lg bg-orange-500 text-slate-900 font-semibold">Submit answers</button>
        `
      },
      {
        id: 'simulation',
        title: 'Interactive Incident Simulation & Certification',
        subtitle: 'Practice the Decision Maker logic then download your certificate.',
        render: () => `
          <div class="glass rounded-xl p-4 border border-white/5 space-y-3">
            <h3 class="text-lg font-semibold text-white flex items-center gap-2"><i data-lucide="compass" class="w-5 h-5 text-orange-300"></i>Interactive incident simulation</h3>
            <p class="text-slate-300 text-sm">Work through a live ransomware alert. Choose your action and see consequences.</p>
            <div id="simulation" class="space-y-2"></div>
          </div>
          <div class="glass rounded-xl p-4 border border-white/5 space-y-3">
            <h3 class="text-lg font-semibold text-white flex items-center gap-2"><i data-lucide="award" class="w-5 h-5 text-orange-300"></i>Certification</h3>
            <p class="text-sm text-slate-300">Score at least 80% on the Knowledge Check to unlock the certificate.</p>
            <div class="space-y-2">
              <label class="block text-sm text-slate-200">Your name</label>
              <input id="cert-name" class="w-full px-3 py-2 rounded-lg bg-slate-900 border border-white/10 text-white" placeholder="Full name" value="${state?.certificateName || ''}">
            </div>
            <button id="certificateBtn" class="w-full md:w-auto px-4 py-2 rounded-lg bg-orange-500 text-slate-900 font-semibold">Generate Certificate PDF</button>
            <p class="text-xs text-slate-400">Certificate will include your name, role, score, and issue date.</p>
          </div>
          <button class="mark-complete w-full md:w-auto mt-4 px-4 py-2 rounded-lg bg-orange-500 text-slate-900 font-semibold">Mark module complete</button>
        `
      }
    ];

    const quizQuestions = [
      { q: 'What is the Golden Hour?', a: 'Report and triage within 60 minutes of detection', options: [ 'Notify legal within 4 hours', 'Report and triage within 60 minutes of detection', 'Patch all systems within 24 hours', 'Escalate only if customer data is involved' ] },
      { q: 'What do you do if the duty manager does not respond within 15 minutes?', a: 'Escalate to the next tier on the matrix', options: [ 'Wait another 30 minutes', 'Close the incident as false positive', 'Escalate to the next tier on the matrix', 'Send a company-wide email' ] },
      { q: 'What is the first containment move for ransomware in OT?', a: 'Isolate the affected VLAN and preserve evidence', options: [ 'Reboot the PLCs immediately', 'Publicly disclose the incident', 'Isolate the affected VLAN and preserve evidence', 'Delete encrypted files to save storage' ] },
      { q: 'Who owns external communications?', a: 'Authorized Communications/Public Affairs lead', options: [ 'Any engineer on shift', 'Authorized Communications/Public Affairs lead', 'The first person who found the issue', 'Only legal counsel' ] },
      { q: 'When should you start the incident bridge?', a: 'Within 30 minutes or sooner if customer impact is likely', options: [ 'After the root cause is confirmed', 'Only after regulators call', 'Within 30 minutes or sooner if customer impact is likely', 'Never for low-level events' ] }
    ];

    function accordionSection(title, subtitle, body){
      return `
        <div class="border border-white/5 rounded-xl overflow-hidden">
          <button class="accordion w-full flex items-center justify-between px-4 py-3 bg-white/5 hover:bg-white/10">
            <span>
              <div class="text-sm text-slate-300">${subtitle}</div>
              <div class="text-base font-semibold text-white">${title}</div>
            </span>
            <i data-lucide="chevron-down" class="w-5 h-5 text-orange-300"></i>
          </button>
          <div class="accordion-body hidden px-4 pb-4 text-sm text-slate-200">${body}</div>
        </div>`;
    }

    function identifyContent(role){
      const universal = '<strong>All roles:</strong> Capture who/what/when, avoid unplugging systems, and record evidence locations.';
      const exec = 'Executives: confirm business impact, authorize comms, and assign an Incident Commander.';
      const tech = 'Technical Responders: validate alerts, snapshot systems, and check OT segmentation status.';
      const staff = 'General Staff: report unusual activity immediately and follow the notify tree.';
      return `${universal}<div class="mt-2 text-slate-400">${role === 'Executive' ? exec : role === 'Technical Responder' ? tech : staff}</div>`;
    }

    function notifyContent(role){
      const base = 'Use the escalation matrix. If no acknowledgement in 15 minutes, move to the next tier.';
      const exec = 'Coordinate with Communications for any external messaging. Approve regulator notifications.';
      const tech = 'Open an incident bridge and invite platform owners. Post concise updates every 15 minutes.';
      const staff = 'Use the hotline or Teams bridge. Share facts only — no speculation.';
      return `${base}<div class="mt-2 text-slate-400">${role === 'Executive' ? exec : role === 'Technical Responder' ? tech : staff}</div>`;
    }

    function containContent(role){
      if(role === 'Technical Responder') {
        return '<ul class="list-disc list-inside space-y-1"><li>Isolate the affected VLAN or device; do not power off.</li><li>Preserve volatile data (RAM/disk images) where safe.</li><li>Block malicious indicators at firewall/proxy.</li><li>Coordinate with OT to avoid safety impacts.</li></ul>';
      }
      return 'Containment is led by Technical Responders. Support by keeping systems stable and following communications discipline.';
    }

    function recoverContent(role){
      const shared = '<ul class="list-disc list-inside space-y-1"><li>Track actions and timestamps in the incident log.</li><li>Document lessons learned and update playbooks.</li><li>Schedule a post-incident review within 5 business days.</li></ul>';
      const exec = 'Approve budget for hardening and ensure business owners attend the review.';
      const tech = 'Collect artifacts for forensics, restore from clean backups, and verify monitoring coverage.';
      const staff = 'Participate in awareness refresh and implement new controls assigned to your team.';
      return `${shared}<div class="mt-2 text-slate-400">${role === 'Executive' ? exec : role === 'Technical Responder' ? tech : staff}</div>`;
    }

    function stepItem(title, desc){
      return `<div class="relative pl-6"><div class="absolute -left-[9px] top-1.5 h-2 w-2 rounded-full bg-orange-400"></div><div class="text-white font-semibold">${title}</div><div class="text-slate-300 text-sm">${desc}</div></div>`;
    }

    const state = JSON.parse(localStorage.getItem('sclCISRProgress') || '{}');
    state.completed = state.completed || {};
    state.role = state.role || null;
    state.quizScore = state.quizScore || 0;
    state.certificateName = state.certificateName || '';
    let currentModule = 0;

    function saveState(){
      localStorage.setItem('sclCISRProgress', JSON.stringify(state));
    }

    function checkProgress(){
      const total = modules.length;
      const done = Object.values(state.completed).filter(Boolean).length;
      const percent = Math.round((done/total)*100);
      document.getElementById('progress-count').textContent = `${done} / ${total}`;
      document.getElementById('progress-bar').style.width = `${percent}%`;
    }

    function setRole(role){
      state.role = role;
      document.getElementById('role-active').textContent = role;
      document.querySelectorAll('.role-card').forEach(card => card.classList.toggle('border-orange-400', card.dataset.role === role));
      saveState();
      renderModule(currentModule);
    }

    function markComplete(id){
      state.completed[id] = true;
      saveState();
      checkProgress();
      renderModuleList();
    }

    function renderModule(index){
      currentModule = Math.max(0, Math.min(index, modules.length-1));
      const mod = modules[currentModule];
      document.getElementById('module-title').textContent = mod.title;
      document.getElementById('module-subtitle').textContent = mod.subtitle;
      const container = document.getElementById('module-content');
      container.innerHTML = typeof mod.render === 'function' ? mod.render(state.role) : mod.render;
      lucide.createIcons();
      attachModuleHandlers(mod.id);
    }

    function attachModuleHandlers(id){
      document.querySelectorAll('.mark-complete').forEach(btn => btn.addEventListener('click', () => markComplete(id)));
      document.querySelectorAll('.accordion').forEach(btn => btn.addEventListener('click', () => {
        const body = btn.nextElementSibling;
        body.classList.toggle('hidden');
        btn.querySelector('svg').classList.toggle('rotate-180');
      }));
      if(id === 'quiz') renderQuiz();
      if(id === 'simulation') {
        renderSimulation();
        const certBtn = document.getElementById('certificateBtn');
        if(certBtn) certBtn.addEventListener('click', generateCertificate);
      }
    }

    function renderModuleList(){
      const list = document.getElementById('module-list');
      list.innerHTML = '';
      modules.forEach((mod, idx) => {
        const li = document.createElement('li');
        li.innerHTML = `
          <button class="w-full flex items-center justify-between px-3 py-2 rounded-lg ${idx === currentModule ? 'bg-orange-500/20 border border-orange-400/40' : 'bg-white/5 border border-white/5'}">
            <span class="text-left">
              <div class="text-xs text-slate-400">${mod.subtitle}</div>
              <div class="text-sm font-semibold text-white">${mod.title}</div>
            </span>
            <i data-lucide="${state.completed[mod.id] ? 'check-circle-2' : 'circle'}" class="w-4 h-4 ${state.completed[mod.id] ? 'text-emerald-400' : 'text-slate-400'}"></i>
          </button>`;
        li.querySelector('button').addEventListener('click', ()=> renderModule(idx));
        list.appendChild(li);
      });
      lucide.createIcons();
    }

    function renderQuiz(){
      const form = document.getElementById('quiz-form');
      const result = document.getElementById('quiz-result');
      form.innerHTML = quizQuestions.map((item, idx) => {
        return `<div class="glass rounded-lg p-3 border border-white/5 space-y-2">
          <div class="font-semibold text-white">${idx+1}. ${item.q}</div>
          ${item.options.map(opt => `<label class="flex items-center gap-2 text-slate-200"><input type="radio" required name="q${idx}" value="${opt}" class="accent-orange-500">${opt}</label>`).join('')}
        </div>`;
      }).join('');
      form.addEventListener('submit', (e) => {
        e.preventDefault();
        let score = 0;
        quizQuestions.forEach((item, idx) => {
          const ans = form.querySelector(`input[name='q${idx}']:checked`);
          if(ans && ans.value === item.a) score += 1;
        });
        const percent = Math.round((score/quizQuestions.length)*100);
        state.quizScore = percent;
        saveState();
        const pass = percent >= 80;
        result.innerHTML = `<div class="mt-2 p-3 rounded-lg ${pass ? 'bg-emerald-500/10 text-emerald-200' : 'bg-red-500/10 text-red-200'}">Score: ${percent}%. ${pass ? 'Great work! Certificate unlocked.' : 'Please review and try again.'}</div>`;
        if(pass) markComplete('quiz');
        checkProgress();
        renderModuleList();
      }, { once: true });
    }

    function renderSimulation(){
      const simEl = document.getElementById('simulation');
      const paths = {
        start: { text: 'Alert: OT workstation shows ransomware note. What is your first move?', options: [ {label:'Isolate affected VLAN', next:'isolate'}, {label:'Announce to all-staff via email', next:'email'}, {label:'Ignore until morning', next:'ignore'} ] },
        isolate: { text:'Containment engaged. SOC sees beaconing. Next step?', options:[{label:'Page duty manager and start bridge', next:'bridge'},{label:'Wipe machine immediately', next:'wipe'}]},
        email: { text:'Uncontrolled comms create panic. This delays containment.', options:[{label:'Return and follow matrix', next:'start'}]},
        ignore: { text:'Golden Hour missed. Impact widens. Restart scenario?', options:[{label:'Restart', next:'start'}]},
        bridge: { text:'Bridge open. Forensics requests snapshot.', options:[{label:'Preserve evidence before reboot', next:'good'},{label:'Reboot now to clear malware', next:'badReboot'}]},
        wipe: { text:'Evidence destroyed. Regulators question chain of custody.', options:[{label:'Restart', next:'start'}]},
        badReboot: { text:'Data loss complicates investigation.', options:[{label:'Restart', next:'start'}]},
        good: { text:'Excellent. You contained, notified, and preserved evidence. Continue to certificate.', options:[]}
      };
      function renderNode(key){
        const node = paths[key];
        simEl.innerHTML = `<div class="p-4 rounded-lg bg-white/5 border border-white/5 text-slate-200">${node.text}</div>`;
        const opts = document.createElement('div');
        opts.className = 'flex flex-wrap gap-2';
        node.options.forEach(opt => {
          const btn = document.createElement('button');
          btn.className = 'mt-2 px-3 py-2 rounded-lg bg-orange-500 text-slate-900 font-semibold';
          btn.textContent = opt.label;
          btn.addEventListener('click', ()=> renderNode(opt.next));
          opts.appendChild(btn);
        });
        simEl.appendChild(opts);
      }
      renderNode('start');
    }

    function generateCertificate(){
      if(state.quizScore < 80){
        alert('Complete the Knowledge Check with a score of at least 80% to unlock the certificate.');
        return;
      }
      const name = document.getElementById('cert-name').value.trim();
      if(!name){ alert('Please enter your name.'); return; }
      state.certificateName = name; saveState();
      const role = state.role || 'Participant';
      const doc = new jsPDF({ orientation:'landscape' });
      doc.setFillColor(11,18,33);
      doc.rect(0,0,297,210,'F');
      doc.setTextColor(255,255,255);
      doc.setFontSize(22);
      doc.text('Certificate of Completion', 148.5, 40, { align:'center' });
      doc.setFontSize(14);
      doc.text('This certifies that', 148.5, 65, { align:'center' });
      doc.setFontSize(26);
      doc.text(name, 148.5, 85, { align:'center' });
      doc.setFontSize(14);
      doc.text('has successfully completed the', 148.5, 100, { align:'center' });
      doc.setFontSize(18);
      doc.setTextColor(251,122,36);
      doc.text('SCL CISR Incident Management Training', 148.5, 115, { align:'center' });
      doc.setTextColor(200,213,237);
      doc.setFontSize(12);
      const date = new Date().toLocaleDateString();
      doc.text(`Role: ${role}`, 148.5, 132, { align:'center' });
      doc.text(`Score: ${state.quizScore}%`, 148.5, 142, { align:'center' });
      doc.text(`Issued on: ${date}`, 148.5, 152, { align:'center' });
      doc.setDrawColor(251,122,36);
      doc.rect(20,20,257,170, 'S');
      doc.save('SCL-CISR-Certificate.pdf');
    }

    function init(){
      document.querySelectorAll('.role-card').forEach(btn => btn.addEventListener('click', ()=> setRole(btn.dataset.role)));
      document.getElementById('prevBtn').addEventListener('click', ()=> renderModule(currentModule - 1));
      document.getElementById('nextBtn').addEventListener('click', ()=> renderModule(currentModule + 1));
      document.getElementById('resumeBtn').addEventListener('click', ()=> {
        const firstIncomplete = modules.findIndex(m => !state.completed[m.id]);
        renderModule(firstIncomplete >=0 ? firstIncomplete : 0);
        document.getElementById('course').scrollIntoView({ behavior:'smooth' });
      });
      document.getElementById('role-active').textContent = state.role || 'Role not selected';
      renderModuleList();
      checkProgress();
      renderModule(currentModule);
    }

    init();
  </script>
</body>
</html>
